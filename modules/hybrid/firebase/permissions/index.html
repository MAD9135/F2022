<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Firebase Permissions | MAD9135</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="JavaScript App Development">
    
    <link rel="preload" href="/F2022/assets/css/0.styles.69eb72d8.css" as="style"><link rel="preload" href="/F2022/assets/js/app.e8c285b9.js" as="script"><link rel="preload" href="/F2022/assets/js/2.9a13455f.js" as="script"><link rel="preload" href="/F2022/assets/js/27.94beb76f.js" as="script"><link rel="preload" href="/F2022/assets/js/6.351fee7d.js" as="script"><link rel="prefetch" href="/F2022/assets/js/10.19db6b1e.js"><link rel="prefetch" href="/F2022/assets/js/11.9c100ec9.js"><link rel="prefetch" href="/F2022/assets/js/12.66792850.js"><link rel="prefetch" href="/F2022/assets/js/13.570695c0.js"><link rel="prefetch" href="/F2022/assets/js/14.6f8baaa9.js"><link rel="prefetch" href="/F2022/assets/js/15.9fe338ad.js"><link rel="prefetch" href="/F2022/assets/js/16.14a225ab.js"><link rel="prefetch" href="/F2022/assets/js/17.9889dd9b.js"><link rel="prefetch" href="/F2022/assets/js/18.b9f44afa.js"><link rel="prefetch" href="/F2022/assets/js/19.1a5d1eb8.js"><link rel="prefetch" href="/F2022/assets/js/20.bfc9c373.js"><link rel="prefetch" href="/F2022/assets/js/21.b0d5e3b9.js"><link rel="prefetch" href="/F2022/assets/js/22.71501c8b.js"><link rel="prefetch" href="/F2022/assets/js/23.c7ffdeef.js"><link rel="prefetch" href="/F2022/assets/js/24.2d7e7868.js"><link rel="prefetch" href="/F2022/assets/js/25.6973b344.js"><link rel="prefetch" href="/F2022/assets/js/26.5381df9b.js"><link rel="prefetch" href="/F2022/assets/js/28.35bb8e11.js"><link rel="prefetch" href="/F2022/assets/js/29.44383e10.js"><link rel="prefetch" href="/F2022/assets/js/3.4ca6bd9c.js"><link rel="prefetch" href="/F2022/assets/js/30.5979e619.js"><link rel="prefetch" href="/F2022/assets/js/31.fe59b532.js"><link rel="prefetch" href="/F2022/assets/js/32.439d6653.js"><link rel="prefetch" href="/F2022/assets/js/33.f324c148.js"><link rel="prefetch" href="/F2022/assets/js/34.3e1bc0a2.js"><link rel="prefetch" href="/F2022/assets/js/35.db6b2965.js"><link rel="prefetch" href="/F2022/assets/js/36.ab816086.js"><link rel="prefetch" href="/F2022/assets/js/37.07e54435.js"><link rel="prefetch" href="/F2022/assets/js/38.deea1f87.js"><link rel="prefetch" href="/F2022/assets/js/39.72fff846.js"><link rel="prefetch" href="/F2022/assets/js/4.b42af5b4.js"><link rel="prefetch" href="/F2022/assets/js/40.f25af6c1.js"><link rel="prefetch" href="/F2022/assets/js/41.b75d764d.js"><link rel="prefetch" href="/F2022/assets/js/42.e7b3e635.js"><link rel="prefetch" href="/F2022/assets/js/43.ef823a68.js"><link rel="prefetch" href="/F2022/assets/js/44.e65ceadf.js"><link rel="prefetch" href="/F2022/assets/js/45.2653971e.js"><link rel="prefetch" href="/F2022/assets/js/46.2e7a0afa.js"><link rel="prefetch" href="/F2022/assets/js/47.c93b6eb6.js"><link rel="prefetch" href="/F2022/assets/js/48.22a6269b.js"><link rel="prefetch" href="/F2022/assets/js/49.cdbc262a.js"><link rel="prefetch" href="/F2022/assets/js/5.aef0857f.js"><link rel="prefetch" href="/F2022/assets/js/50.411c7402.js"><link rel="prefetch" href="/F2022/assets/js/51.5a18911f.js"><link rel="prefetch" href="/F2022/assets/js/52.ce0eea3f.js"><link rel="prefetch" href="/F2022/assets/js/53.d55f9ed3.js"><link rel="prefetch" href="/F2022/assets/js/54.6a7af4f1.js"><link rel="prefetch" href="/F2022/assets/js/55.8779cc6a.js"><link rel="prefetch" href="/F2022/assets/js/56.281c9c8b.js"><link rel="prefetch" href="/F2022/assets/js/57.e36954dd.js"><link rel="prefetch" href="/F2022/assets/js/58.5c8be1f9.js"><link rel="prefetch" href="/F2022/assets/js/7.0bb8b12a.js"><link rel="prefetch" href="/F2022/assets/js/8.a2a70e3a.js"><link rel="prefetch" href="/F2022/assets/js/9.5279d356.js">
    <link rel="stylesheet" href="/F2022/assets/css/0.styles.69eb72d8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/F2022/" class="home-link router-link-active"><img src="/F2022/mad-d-logo-sm.png" alt="MAD9135" class="logo"> <span class="site-name can-hide">MAD9135</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/F2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/F2022/deliverables/" class="nav-link">
  Assignments
</a></div><div class="nav-item"><a href="/F2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/F2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/F2022/deliverables/" class="nav-link">
  Assignments
</a></div><div class="nav-item"><a href="/F2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Firebase Hybrid Content</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/F2022/modules/hybrid/firebase/" aria-current="page" class="sidebar-link">Firebase Introduction</a></li><li><a href="/F2022/modules/hybrid/firebase/firestore/" class="sidebar-link">Firebase Firestore</a></li><li><a href="/F2022/modules/hybrid/firebase/firestore/sample.html" class="sidebar-link">Firestore Starter Project</a></li><li><a href="/F2022/modules/hybrid/firebase/authentication/" class="sidebar-link">Firebase Authentication</a></li><li><a href="/F2022/modules/hybrid/firebase/permissions/" aria-current="page" class="active sidebar-link">Firebase Permissions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/F2022/modules/hybrid/firebase/permissions/#setting-permissions-for-access-to-firestore" class="sidebar-link">Setting Permissions for Access to Firestore</a></li><li class="sidebar-sub-header"><a href="/F2022/modules/hybrid/firebase/permissions/#hybrid-assignment-3" class="sidebar-link">Hybrid Assignment 3</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Next JS &amp; React Native</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><header><div class="section-title gold">
    Firebase
  </div> <h1>Firebase Permissions</h1></header> <h2 id="setting-permissions-for-access-to-firestore"><a href="#setting-permissions-for-access-to-firestore" class="header-anchor">#</a> Setting Permissions for Access to Firestore</h2> <p>We actually talked about these very briefly in the initial discussion about setting up the Firebase app and database.</p> <p>In the Firebase console, in the Firestore Cloud Database section, go from the default <code>data</code> tab to the <code>rules</code> tab. You will see something like this:</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-js"><code>rules_version <span class="token operator">=</span> <span class="token string">'2'</span><span class="token punctuation">;</span>
service cloud<span class="token punctuation">.</span>firestore <span class="token punctuation">{</span>
  match <span class="token operator">/</span>databases<span class="token operator">/</span><span class="token punctuation">{</span>database<span class="token punctuation">}</span><span class="token operator">/</span>documents <span class="token punctuation">{</span>
    match <span class="token operator">/</span><span class="token punctuation">{</span>document<span class="token operator">=</span><span class="token operator">**</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token punctuation">,</span> <span class="token literal-property property">write</span><span class="token operator">:</span> <span class="token keyword">if</span>
          request<span class="token punctuation">.</span>time <span class="token operator">&lt;</span> timestamp<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Notice the <code>timestamp.date</code> value on the highlighted line and how it is currently set to Dec 25th, 2022. This is a base permission set that allows any user to read or write to the database up until that date.</p> <p><a href="https://firebase.google.com/docs/firestore/security/get-started" target="_blank" rel="noopener noreferrer">Firestore security overview reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://firebase.google.com/docs/firestore/quickstart#secure_your_data" target="_blank" rel="noopener noreferrer">Firestore quickstart for securing your data<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>The syntax of the rules file is similar to JavaScript. There will be many sets of <code>{}</code> nested inside of each other.</p> <p>The <code>match</code> commands are trying to match parts of the path in your database. Every time you try to connect to the database and read or write some data, these <code>match</code> commands run. If we were talking about setting permissions on documents that were inside the <code>people</code> collection that we have been using, then a path could be <code>/databases/fire-giftr/people/documents/</code>. The name of the database can be replaced with <code>{database}</code>. This will take the second part of the path and create a variable called <code>database</code> that can be used inside of the set of <code>{}</code> after the match.</p> <p>The first match statement in the example above is <code>match /databases/{database}/documents {</code>. It has no collection name specified. Instead, it is matching all documents in all collections in the database. If you want, you can create a different match statement for each collection.</p> <p>In the second match statement, <code>match /{document=**} {</code> the command will match against any and all documents from any collection specified in the parent match statement.</p> <p>Once you have your match command to find the appropriate documents, then we use the <code>allow</code> command. You can write one <code>allow</code> command for both <code>read</code> and <code>write</code> or separate ones for each. After the <code>allow</code>, you need to add an <code>if</code> statement.</p> <p>If you want to restrict access to all documents to users who are logged in, you could use this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>allow read<span class="token punctuation">,</span> <span class="token literal-property property">write</span><span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>auth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>When adding restrictions on READ operations, be careful about what you disallow. If you need to be able to access documents in a <code>users</code> collection when a person is logging in, then do not include <code>allow read request.auth != null</code> in your rules. You wouldn't be able to read the user collection and compare its values to values from the website.</p> <p>Here is a rule that says that documents in the <code>users</code> collection can be <code>read</code>, <code>update</code>, or <code>delete</code>, if the user doing the operation is signed in AND the id of the user matches the id in the record being read, updated, or deleted. In order to create a new document in the collection, the person must not be signed in.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>match <span class="token operator">/</span>users<span class="token operator">/</span><span class="token punctuation">{</span>userId<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token punctuation">,</span> update<span class="token punctuation">,</span> <span class="token keyword">delete</span><span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>auth <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid <span class="token operator">==</span> userId<span class="token punctuation">;</span>
      allow create<span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>auth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Here is a rule that says anyone can <code>Read</code> from the <code>people</code> collection but only users who are signed in with Firebase Authentication can <code>Write</code>. And, only signed in users can read from the <code>gift-ideas</code> and nobody can write to the collection.  <code>person</code> and <code>idea</code> are turned into variables that could be used in those if statements.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>rules_version <span class="token operator">=</span> <span class="token string">'2'</span><span class="token punctuation">;</span>
service cloud<span class="token punctuation">.</span>firestore <span class="token punctuation">{</span>
  match <span class="token operator">/</span>databases<span class="token operator">/</span><span class="token punctuation">{</span>database<span class="token punctuation">}</span><span class="token operator">/</span>documents <span class="token punctuation">{</span>

    <span class="token comment">// Match any document in the 'people' collection</span>
    match <span class="token operator">/</span>people<span class="token operator">/</span><span class="token punctuation">{</span>person<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      allow write<span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>auth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Match any document in the 'gift-ideas' collection</span>
    match <span class="token operator">/</span>gift<span class="token operator">-</span>ideas<span class="token operator">/</span><span class="token punctuation">{</span>idea<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>auth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      allow write<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    match <span class="token operator">/</span>users<span class="token operator">/</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      allow write<span class="token operator">:</span> <span class="token keyword">if</span> user<span class="token punctuation">.</span>id <span class="token operator">==</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>id 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>Other keywords for <code>allow</code> include</p> <ul><li><code>get</code> applies to single document read requests</li> <li><code>list</code> applies to getDocs, queries, and collection reads</li> <li><code>update</code> applies to setDoc write commands</li> <li><code>create</code> applies to addDoc write commands</li> <li><code>delete</code> you should be able to guess this one</li></ul> <p>If there are multiple match commands that overlap and apply to the same data, then the operation will be allowed if ANY of the match and allow statements allow it.</p> <p>If you want to restrict a create command to force certain fields to be present before the create can run.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>match <span class="token operator">/</span>people<span class="token operator">/</span><span class="token punctuation">{</span>person<span class="token punctuation">}</span> <span class="token punctuation">{</span>
  allow create<span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'birth-month'</span><span class="token punctuation">,</span> <span class="token string">'birth-day'</span><span class="token punctuation">,</span> <span class="token string">'owner'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>In the <code>if</code> statement <code>request.resource.data</code> is the object being passed to the database. The <code>keys()</code> method returns an array of all the property names in the object. <code>hasAll()</code> lets you provide a list of required fields. There is also an <code>affectedKeys()</code> method that will give you the names of the fields that were affected by a write operation, eg an update.</p> <p>If you want to ensure that submitted objects have the correct datatypes:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>allow write<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>data<span class="token punctuation">.</span>name is string <span class="token operator">&amp;&amp;</span>
          request<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>data<span class="token punctuation">.</span>birth<span class="token operator">-</span>month is int <span class="token operator">&amp;&amp;</span>
          request<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>data<span class="token punctuation">.</span>birth<span class="token operator">-</span>day is int <span class="token operator">&amp;&amp;</span>
          request<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>data<span class="token punctuation">.</span>owner is path <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Valid data types for the is operator are bool, bytes, float, int, list, latlng, number, path, map, string, and timestamp.</p> <h2 id="hybrid-assignment-3"><a href="#hybrid-assignment-3" class="header-anchor">#</a> Hybrid Assignment 3</h2> <p>The third Hybrid assignment has a full description of the requires in the assignment page in BS LMS. This is the general description and steps to achieve it.</p> <p>To complete the third Hybrid assignment, you need to start with the second Hybrid that includes the ability to sign in and out with Firebase Authentication.</p> <p>In this assignment you will add two important features:</p> <ol><li>Modifying the database to store user information and separate access to that data based on the user.</li> <li>Adding permissions to the database to prevent attempts to circumvent the data access by changing the JavaScript.</li></ol> <p>The first feature is the ability to connect data to specific users. The same <code>people</code> and <code>gift-ideas</code> collections will be used but another <code>users</code> collection will be added to track the people using the website and you will add an <code>owner</code> property to the <code>people</code> collection.</p> <p>The documents in the <code>people</code> collection need to now include a <code>user id</code>.  You can use a <code>String</code> property to hold on to the user id in the people documents. When a person is added to the collection, the user id should be added too. When the list of people is shown, only the people belonging to the current user id should be shown. This will require you modifying your code to include the user id in a query to retrieve the list of people.</p> <p>A more common approach when adding ownership of a document is to create a collection in the database called <code>users</code>. The documents in the <code>users</code> collection will hold the user id, user displayName, and any other user information that you want. The user id in the <code>users</code> collection documents will be the user id that we get from the sign in process. Once you have a collection that holds the users, it means that we can use a <code>Reference</code> property instead of a <code>String</code> property in the <code>people</code> collection documents.</p> <p>So, the documents in the <code>users</code> collection will look like this:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0sZd4GoCLLe7zmly1xO3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;displayName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Sterling Archer&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Other properties are allowed but are optional. Values like the user email, the time the account was created or the last login time are common values to keep in the <code>users</code> documents.</p> <p>The new version of the documents in <code>people</code> looks like:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;G9X6SFu6hGogyqvX19tO&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Rick&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;birth-month&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
  <span class="token property">&quot;birth-day&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token property">&quot;owner&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/users/0sZd4GoCLLe7zmly1xO3&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>The <code>owner</code> property is a Reference data type pointing to a document in the <code>users</code> collection.</p> <p>For this to work, we need to be putting the user information into a document in the <code>users</code> collection when they sign in. We don't need to do this when they change pages and we <code>reauthenticateWithCredential</code>. This is just the first login on the site for each session.</p> <p>We can use the <code>setDoc()</code> method for adding or updating. Call the <code>doc()</code> method to try and find a reference to a document with the specified id. If the document does not exist, it gets created by the <code>doc()</code> method. Then the <code>setDoc()</code> does an update on the document. So, if the user changed their displayName or email or anything else in the <code>user</code> object returned from the provider, then that new information will be put into your <code>users</code> collection document.</p> <p>The id that we are using is the one that refers to the users Github or Twitter account.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">attemptLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//add the setPersistence function here if not doing your own session code </span>

  <span class="token function">signInWithPopup</span><span class="token punctuation">(</span>auth<span class="token punctuation">,</span> provider<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> result<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
      <span class="token comment">//call setDoc to add/update the user document in the `users` collection </span>
      <span class="token keyword">const</span> usersColRef <span class="token operator">=</span> <span class="token function">collection</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setDoc</span><span class="token punctuation">(</span><span class="token function">doc</span><span class="token punctuation">(</span>usersColRef<span class="token punctuation">,</span> user<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">displayName</span><span class="token operator">:</span> user<span class="token punctuation">.</span>displayName
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">merge</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">// plus any other fields you want to save in the object </span>
      <span class="token comment">//When calling doc(), if the document does not exist, it will be created</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token comment">//handle errors</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>by adding the <code>{merge:true}</code> object as the third parameter for <code>setDoc</code> it means nothing will be written to the database if the user already exists and no changes to the data are present.</p> <p>When you need a reference to a specific user document, for a signed in user, you can also use the <code>FirebaseAuth.instance.currentUser.uid</code> property to find the user document.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">doc</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> FirebaseAuth<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>currentUser<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ref<span class="token punctuation">;</span> <span class="token comment">//if you need the user reference</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Your <code>people</code> collection documents should use a new property called <code>owner</code>, which is a reference to a user document, you can use the above method to get a reference to the currently signed in user.</p> <p>Then your <code>getDocs</code> process in the <code>getPeople</code> function, would become a new query with a filter.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getPeople</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> userRef <span class="token operator">=</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> peopleCollectionRef <span class="token operator">=</span> <span class="token function">collection</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&quot;people&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//collection we want to query</span>
  <span class="token keyword">const</span> docs <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span>
    peopleCollectionRef<span class="token punctuation">,</span>
    <span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'owner'</span><span class="token punctuation">,</span> <span class="token string">'=='</span><span class="token punctuation">,</span> userRef<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> querySnapshot <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDocs</span><span class="token punctuation">(</span>docs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  querySnapshot<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
    <span class="token comment">//loop through people documents that are owned by the logged in user</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>The second feature is the setting up of Database permissions, as explained at the top of this page.</p> <p>The minimum permissions that you will need in your database are:</p> <ul><li>Documents in the <code>people</code> collection can only be read, updated or deleted if the owner field matches the path of the logged in user.</li> <li>New documents in the <code>people</code> collection can be created by anyone who is logged in.</li> <li>Documents in the <code>gift-ideas</code> collection can be read or written by anyone who is logged in.</li> <li>Users can only read, update, or delete their own document in the <code>users</code> collection.</li> <li>Anyone can create new documents in the <code>users</code> collection.</li></ul> <p>You can add other permissions as you wish.</p> <p>Once both of these features have been completed, you will have built an app with a secure database which is accessible only to users who have logged into your app using Github or Twitter credentials, they will only be able to access their own data, and all the <code>user</code>, <code>people</code>, and <code>idea</code> data will be connected and organized so the proper query will run efficiently to return each user only their own data.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/5/2022, 2:02:39 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/F2022/modules/hybrid/firebase/authentication/" class="prev">
        Firebase Authentication
      </a></span> <span class="next"><a href="/F2022/modules/react/week1/1.1/">
        1.1: Intro and Review
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/F2022/assets/js/app.e8c285b9.js" defer></script><script src="/F2022/assets/js/2.9a13455f.js" defer></script><script src="/F2022/assets/js/27.94beb76f.js" defer></script><script src="/F2022/assets/js/6.351fee7d.js" defer></script>
  </body>
</html>
